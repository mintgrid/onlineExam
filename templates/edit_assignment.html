{% extends "base.html" %}

{% block title %}Edit Assignment - Admin Portal{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div style="margin-bottom: 1rem;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    
    <div class="dashboard-header">
        <h1 style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
            <i class="fas fa-edit"></i> Edit Assignment
        </h1>
        <p style="color: #6b7280;">Modify exam assignment details</p>
    </div>

    <div class="card glass-morphism" style="max-width: 700px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="color: #1e40af; margin-bottom: 1rem;">
                <i class="fas fa-info-circle"></i> Assignment Details
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; color: #1e40af;">
                <div><strong>Student:</strong> {{ assignment.user.username }}</div>
                <div><strong>Email:</strong> {{ assignment.user.email }}</div>
                <div><strong>Exam:</strong> {{ assignment.exam.title }}</div>
                <div><strong>Duration:</strong> {{ assignment.exam.duration_minutes }} minutes</div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('edit_assignment', assignment_id=assignment.id) }}">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-plus"></i> Start Time
                </label>
                <input type="datetime-local" 
                       name="start_time" 
                       class="form-control" 
                       value="{{ assignment.start_time.strftime('%Y-%m-%dT%H:%M') }}" 
                       required>
                <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                    When the exam becomes available for the student
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-calendar-times"></i> End Time
                </label>
                <input type="datetime-local" 
                       name="end_time" 
                       class="form-control" 
                       value="{{ assignment.end_time.strftime('%Y-%m-%dT%H:%M') }}" 
                       required>
                <small style="color: #6b7280; display: block; margin-top: 0.5rem;">
                    Last time the student can start the exam
                </small>
            </div>

            <div class="form-group">
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 12px;">
                    <p style="color: #92400e; margin: 0;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Note:</strong>
                        The student must start the exam between these times. Once started, they have {{ assignment.exam.duration_minutes }} minutes to complete it.
                    </p>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <a href="{{ url_for('view_assignments') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="button" onclick="deleteAssignment({{ assignment.id }})" class="btn btn-danger" style="margin-left: auto;">
                    <i class="fas fa-trash"></i> Delete Assignment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function deleteAssignment(assignmentId) {
    if (confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
        fetch(`/admin/assignment/${assignmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Assignment deleted successfully');
                window.location.href = '/admin/assignments';
            } else {
                alert('Error deleting assignment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting assignment');
        });
    }
}

// Validate that end time is after start time
document.addEventListener('DOMContentLoaded', function() {
    const startTime = document.querySelector('input[name="start_time"]');
    const endTime = document.querySelector('input[name="end_time"]');
    
    function validateTimes() {
        if (startTime.value && endTime.value) {
            const start = new Date(startTime.value);
            const end = new Date(endTime.value);
            
            if (end <= start) {
                endTime.setCustomValidity('End time must be after start time');
            } else {
                endTime.setCustomValidity('');
            }
        }
    }
    
    startTime.addEventListener('change', validateTimes);
    endTime.addEventListener('change', validateTimes);
});
</script>
{% endblock %}