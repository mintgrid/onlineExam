{% extends "base.html" %}

{% block title %}Manage Assignments - Admin Portal{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div style="margin-bottom: 1rem;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    
    <div class="dashboard-header">
        <h1 style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
            <i class="fas fa-tasks"></i> Manage Exam Assignments
        </h1>
        <p style="color: #6b7280;">View, edit, and manage all exam assignments</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card glass-morphism">
            <div class="stat-value">{{ active_assignments|length }}</div>
            <div class="stat-label">Active Assignments</div>
        </div>
        <div class="stat-card glass-morphism">
            <div class="stat-value">{{ completed_assignments|length }}</div>
            <div class="stat-label">Completed Assignments</div>
        </div>
        <div class="stat-card glass-morphism">
            <div class="stat-value">{{ (active_assignments|length + completed_assignments|length) }}</div>
            <div class="stat-label">Total Assignments</div>
        </div>
    </div>

    <div class="card glass-morphism">
        <h2 class="card-title">
            <i class="fas fa-clock"></i> Active Assignments
        </h2>
        {% if active_assignments %}
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Email</th>
                        <th>Exam</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in active_assignments %}
                    <tr>
                        <td><strong>{{ assignment.user.username }}</strong></td>
                        <td>{{ assignment.user.email }}</td>
                        <td>{{ assignment.exam.title }}</td>
                        <td>{{ assignment.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ assignment.end_time.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ assignment.exam.duration_minutes }} mins</td>
                        <td>
                            <span class="badge badge-success">
                                <i class="fas fa-play"></i> Active
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('edit_assignment', assignment_id=assignment.id) }}" class="btn btn-primary" style="padding: 0.35rem 0.7rem; font-size: 0.85rem; margin-right: 0.5rem;">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button onclick="deleteAssignment({{ assignment.id }})" class="btn btn-danger" style="padding: 0.35rem 0.7rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <p class="empty-state-text">No active assignments</p>
        </div>
        {% endif %}
    </div>

    <div class="card glass-morphism">
        <h2 class="card-title">
            <i class="fas fa-check-circle"></i> Completed Assignments
        </h2>
        {% if completed_assignments %}
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Exam</th>
                        <th>Assigned Period</th>
                        <th>Score</th>
                        <th>Completion Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in completed_assignments %}
                    <tr>
                        <td><strong>{{ assignment.user.username }}</strong></td>
                        <td>{{ assignment.exam.title }}</td>
                        <td>{{ assignment.start_time.strftime('%Y-%m-%d') }} to {{ assignment.end_time.strftime('%Y-%m-%d') }}</td>
                        <td>
                            {% for result in assignment.exam.results %}
                                {% if result.user_id == assignment.user_id %}
                                    <span class="badge {% if result.percentage >= 80 %}badge-success{% elif result.percentage >= 60 %}badge-warning{% else %}badge-danger{% endif %}">
                                        {{ result.score }}/{{ result.total_marks }} ({{ result.percentage|round(1) }}%)
                                    </span>
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% for result in assignment.exam.results %}
                                {% if result.user_id == assignment.user_id %}
                                    {{ result.submitted_at.strftime('%Y-%m-%d %H:%M') }}
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <button onclick="deleteAssignment({{ assignment.id }})" class="btn btn-danger" style="padding: 0.35rem 0.7rem; font-size: 0.85rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <p class="empty-state-text">No completed assignments yet</p>
        </div>
        {% endif %}
    </div>

    <div style="margin-top: 2rem;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{{ url_for('assign_exam') }}" class="btn btn-primary" style="margin-left: 1rem;">
            <i class="fas fa-plus"></i> Create New Assignment
        </a>
    </div>
</div>

<script>
function deleteAssignment(assignmentId) {
    if (confirm('Are you sure you want to delete this assignment? This action cannot be undone.')) {
        fetch(`/admin/assignment/${assignmentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Assignment deleted successfully');
                location.reload();
            } else {
                alert('Error deleting assignment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting assignment');
        });
    }
}
</script>
{% endblock %}